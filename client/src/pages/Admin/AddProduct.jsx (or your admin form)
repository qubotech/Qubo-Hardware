import React, { useEffect, useRef, useState } from 'react'
import { useAppContext } from '../context/AppContext'
import ProductCard from '../components/ProductCard'
import MainBanner from '../components/MainBanner'
import Categories from '../components/Categories'
import BestSeller from '../components/BestSeller'
import BottomBanner from '../components/BottomBanner'
import NewsLetter from '../components/NewsLetter'
import Details from '../components/VoiceOfTrust'

const Home = () => {
  const { products } = useAppContext();
  const scrollContainerRef = useRef(null);
  const [isScrolling, setIsScrolling] = useState(true);

  // Filter best sellers
  const bestSellerProducts = products.filter(product => product.isBestSeller);

  // Auto-scroll Best Sellers
  useEffect(() => {
    const container = scrollContainerRef.current;
    if (!container || !products || products.length === 0) return;

    let scrollInterval;
    let pauseTimeout;

    const startScrolling = () => {
      scrollInterval = setInterval(() => {
        if (container.scrollLeft >= container.scrollWidth - container.clientWidth) {
          // Reset to start
          container.scrollLeft = 0;
          setIsScrolling(false);
          
          // Pause for 2 seconds
          clearInterval(scrollInterval);
          pauseTimeout = setTimeout(() => {
            setIsScrolling(true);
            startScrolling();
          }, 2000);
        } else {
          container.scrollLeft += 1;
        }
      }, 20);
    };

    if (isScrolling) {
      // Initial pause of 1 second
      pauseTimeout = setTimeout(() => {
        startScrolling();
      }, 1000);
    }

    return () => {
      clearInterval(scrollInterval);
      clearTimeout(pauseTimeout);
    };
  }, [isScrolling, products]);

  // Pause on hover
  const handleMouseEnter = () => setIsScrolling(false);
  const handleMouseLeave = () => setIsScrolling(true);

  return (
    <div className='mt-10'>
      <MainBanner />
      <Categories />
      <div id="best-sellers">
        <BestSeller />
      </div>
      <div className="my-20">
        <div className="flex flex-col items-center w-max mx-auto">
          <p className="text-4xl font-medium">Freshies</p>
          <div className="w-20 h-1 bg-primary rounded-full mt-2"></div>
        </div>

        <div 
          ref={scrollContainerRef}
          onMouseEnter={handleMouseEnter}
          onMouseLeave={handleMouseLeave}
          className="overflow-x-auto scrollbar-hide mt-10"
          style={{ 
            scrollBehavior: 'smooth',
            WebkitOverflowScrolling: 'touch'
          }}
        >
          <div className="flex gap-6 min-w-max px-4">
            {bestSellerProducts.length > 0 ? (
              bestSellerProducts.map((product, index) => (
                <div key={index} className="w-64 flex-shrink-0">
                  <ProductCard product={product} />
                </div>
              ))
            ) : (
              products
                .filter((product) => product.inStock)
                .slice(0, 12)
                .map((product, index) => (
                  <div key={index} className="w-64 flex-shrink-0">
                    <ProductCard product={product} />
                  </div>
                ))
            )}
          </div>
        </div>
      </div>
      <Details />
      <BottomBanner />
      <NewsLetter />
    </div>
  )
}

export default Home